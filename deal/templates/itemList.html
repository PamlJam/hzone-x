{% extends 'base.html' %}
{% load static %}
{% block title %}
    hzone | äº¤æ˜“
{% endblock %}

{% block main %}
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="input-group">
            <!-- è¾“å…¥æ¡†ç»„ -->
                <input id='search-input' type="text" class="form-control" placeholder="æœç´¢ç‰©å“å...">
                <span class="input-group-btn">
                    <button id='search-button' class="btn btn-default" type="button">
                        <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                    </button>
                </span>
            </div>
            <br>
            <a href="/deal">
                <button type="button" class="btn btn-info">
                    æ‰€æœ‰å•†å“ <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                </button>
            </a>
            {% if sort == 'price' %}
                <a href="/deal?sort=-price">
                    <button id='price' type="button" class="btn btn-primary active">
                        ä»·æ ¼å‡åº <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                    </button>
                </a>
            {% elif sort == '-price' %}
                <a href="/deal">
                    <button id='price' type="button" class="btn btn-primary active">
                        ä»·æ ¼é™åº <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                    </button>
                </a>
            {% else %}
                <a href="/deal/?sort=price">
                    <button id='price' type="button" class="btn btn-info">
                        ä»·æ ¼æ’åº <span class="glyphicon glyphicon-resize-vertical" aria-hidden="true"></span>
                    </button>
                </a>
            {% endif %}
            <!-- å½¢æˆé—­ç¯ -->
            {% if sort == 'time' %}
                <a href="/deal?sort=-time">
                    <button type="button" class="btn btn-primary active">
                        æ—¶é—´å‡åº <span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>
                    </button>
                </a>
            {% elif sort == '-time' %}
                <a href="/deal">
                    <button type="button" class="btn btn-primary active">
                        æ—¶é—´é™åº <span class="glyphicon glyphicon-arrow-down" aria-hidden="true"></span>
                    </button>
                </a>
            {% else %}
                <a href="/deal?sort=time">
                    <button type="button" class="btn btn-info">
                        æ—¶é—´æ’åº <span class="glyphicon glyphicon-resize-vertical" aria-hidden="true"></span>
                    </button>
                </a>
            {% endif %}

            {% if chop != '1' %}
                <a href="/deal?chop=1">
                    <button id='chop' type="button" class="btn btn-info">
                        åªçœ‹å¯åˆ€ <span class="glyphicon glyphicon-ok-sign" aria-hidden="true"></span>
                    </button>
                </a>
            {% else %}
                <a href="/deal">
                    <button id='chop' type="button" class="btn btn-primary active">
                        åªçœ‹å¯åˆ€ <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span>
                    </button>
                </a>
            {% endif %}
        </div>
    </div>

	<style type="text/css">
        * {
            margin:0;
            padding:0;
        }
        html,body{
            height:100%;
        }
		.htmleaf-content img{
			height: 200px;
		}
		.htmleaf-content img.lightense-open{
            height:300px;
            display: inline-block;
		}
	</style>
    {% for item in items %}
        <div class="panel panel-info">
            <div class="panel-body">
                <div class="media" id = 'item-{{ item.id }}'>
                <!-- åª’ä½“å¯¹è±¡ -->
                    <div class="media-left media-middle">
                    <!-- é å·¦ å‚ç›´å±…ä¸­ -->
                    {% if item.image %}
                        <div class="htmleaf-content">
                            <div class="media-object img-thumbnail">
                            <!-- åœ†è§’è¾¹æ¡† -->
                                <img class="zoom" src="/{{ item.image }}">
                            </div>
                        </div>
                    {% else %}
                        <img src="{% static 'image/items/default.png' %}" style="height:200px" class="media-object img-thumbnail" >
                        <!-- æ˜¾ç¤ºé»˜è®¤å›¾ç‰‡ -->
                    {% endif %}
                    </div>
                    <div class="media-body">
                        <h4>{{ item.name }}</h4>
                        <hr>    
                        <em>
                        <!-- æ–œä½“å­— -->
                            <font style="color:grey" size="2">
                            <!-- å…¶ä»–å­—ä½“å±æ€§ -->
                                {{ item.info }}
                            </font> 
                        </em>
                        <hr>
                        ï¿¥ <font size="4" face="Verdana">{{ item.price }}</font> 
                        <hr>
                        <span class="label label-default"> x {{ item.count }}</span>
                        {% if item.chop %}
                            <span class="label label-success">å¯åˆ€</span>
                        {% else %}
                            <span class="label label-danger">ä¸åˆ€</span>
                        {% endif %}
                        <span class="label label-warning">{{ item.time | date:"Y-m-d" }}</span>
                    </div>
                </div>
            </div>

            <div class="panel-footer">
            <!-- é¢æ¿çš„åº•éƒ¨ -->
                <div align="left" style="float:left">
                <!-- åŒä¸€è¡Œé å·¦ -->
                    {% if item.owner == user %}
                        <button type="button" class="btn btn-success btn-xs">æˆ‘çš„å•†å“</button>
                    {% else %}
                        <a target = "_blank" href="/user/{{item.owner.id}}">
                            <button type="button" class="btn btn-default btn-xs">è¿›å…¥ä¸»é¡µ ğŸ </button>
                        </a>
                    {% endif %}
                    <button id="replyButton-{{ forloop.counter }}" type="button" class="btn btn-default btn-xs">
                    <!-- ä¸‹æ‹‰æŒ‰é’® -->å‘å¸ƒè¯„è®ºï¼ˆ{{ item.comments.count }}ï¼‰ â–¼</button>
                </div>
    
                <div align="right">
                <!-- åŒä¸€è¡Œé å³ -->
                    <a href="/collect/{{ item.pk }}">
                        {% if item.is_collected %}
                            <button id="demark-{{ forloop.counter }}" type="button"
                                class="btn btn-danger btn-xs">å·²æ ‡è®°</button>
                        {% else %}
                            <button id="mark-{{ forloop.counter }}" type="button" 
                                class="btn btn-default btn-xs">æ ‡è®° ğŸš©</button>
                        {% endif %}
                    </a>
                </div>
            </div>
            <div id="replyArea-{{ forloop.counter }}" class="hidden">
            <!-- ä¸‹æ‹‰è¯„è®ºåŒºï¼šé»˜è®¤éšè— -->
                <form id="replyForm-{{ forloop.counter }}" action="/deal/{{ item.id }}" method='post'>
                <!-- è¯„è®ºè¡¨å• -->
                {% csrf_token %}
                    <div class="input-group">
                        <input id="replyInput-{{ forloop.counter }}"  name="text"  maxlength="30"
                        type="text" class="form-control" placeholder="å’¨è¯¢è¯¦ç»†ä¿¡æ¯ï¼ˆä¸è¶…è¿‡30å­—ï¼‰">
                        <span class="input-group-btn">
                            <button type="submit" class="btn btn-info" type="button">å‘è¡¨</button>
                        </span>
                    </div>
                </form>
                <table id="replyTable-{{ forloop.counter }}" class="table">
                <!-- è¯„è®ºè¡¨æ ¼ -->
                    <tr>
                    <!-- è¡¨å¤´ -->
                        <th width="20%">ç”¨æˆ·</th>
                        <th width="60%">å†…å®¹</th>
                        <th width="20%">æ—¶é—´</th>
                    </tr>
                    {% for comment in item.comments %}
                    <!-- å¡«è¡¨ -->
                        <tr>
                            {% if comment.user == item.owner %}
                                <td>
                                    <a href="/user/{{comment.user.id}}">
                                        <strong><em>ï¼ˆå–å®¶ï¼‰</em></strong>
                                        {{ comment.user }}
                                    </a>
                                </td>
                            {% else %}
                                <td>
                                    <a href="/user/{{comment.user.id}}">{{ comment.user }}</a>
                                </td>
                            {% endif %}
                            <td>{{ comment.text }}</td>
                            <td>{{ comment.time | date:"Y-m-d"}}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td></td>
                            <td>æš‚æ— è¯„è®º</td>
                            <td></td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    {% empty %}
        <div class="panel panel-default">
            <div class="panel-body">
                <h3>æš‚æ— å†…å®¹</h3>
            </div>
        </div>
    {% endfor %}
{% endblock %}

{% block side %}
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">æ‰€æœ‰æ ‡è®°</h3>
        </div>
        <ul class="list-group">
        <!-- æ”¶è—åˆ—è¡¨ -->
            {% for item in items %}
                {% if item.is_collected %}
                    <li class="list-group-item">
                        <a href="#item-{{ item.id }}">
                        <!-- æœ¬é¡µè·³è½¬ -->
                            <span class="label label-info">{{ item.name }}</span>
                        </a>
                        ï¿¥<strong><em> {{ item.price }}</em></strong>
                    </li>
                {% endif %}
            {% empty %}
                <li class="list-group-item">æš‚æ— æ ‡è®°å†…å®¹</li>
            {% endfor %}
        </ul>
    </div>
{% endblock %}
{% block js %}
	<script type="text/javascript" src="{% static 'js/lightense.js' %}">
    // è½½å…¥æ’ä»¶
    // ä¸å†™ä»£ç  **
    </script>
	<script type="text/javascript">
    // æ’ä»¶åˆå§‹åŒ–
		window.addEventListener('load', function () {
		  var el = document.querySelectorAll('img.zoom:not(.no-lightense),.lightense');
		  Lightense(el);
		  }, false);
	</script>
    <script>
        $('#search-button').click(function(){
            var input = $('#search-input').val()
            // è·å–å…³é”®è¯
            location.href = '?search=' + input
        })
    </script>

    <script>
        var len = {{ items.count }}
        // è·å–åˆ—è¡¨é•¿åº¦
        for(var i=1;i<=len;i++){
        // å¾ªç¯ç»‘å®šäº‹ä»¶
            (function (i) {
                var area = $('#replyArea-' + i)
                var form = $('#replyForm-' + i)
                var input = $('#replyInput-' + i)
                var button = $('#replyButton-' + i)
                // æ‹¼æ¥è·å–å…ƒç´ 
                button.click(function(){
                // ç‚¹å‡»ä¸‹æ‹‰æŒ‰é’®
                    if (area.attr("class")){
                        area.removeAttr('class')
                        // ç§»é™¤å±æ€§
                        button.val('å‘å¸ƒè¯„è®ºï¼ˆ{{ item.comments.count }}ï¼‰ â–²')
                        // ä¿®æ”¹æ ·å¼
                    }
                    else{
                        area.attr("class","hidden")
                        // å¢åŠ å±æ€§
                        button.val('å‘å¸ƒè¯„è®ºï¼ˆ{{ item.comments.count }}ï¼‰ â–¼')
                    }
                })
                form.submit(function(){
                    $.ajax({
                        url:form.attr("action"),
                        type:form.attr("method"),
                        data:$(this).serialize(),
                        cache:false,
                        success:function(){
                            $("#replyTable-" + i).load(location.href + " #replyTable-" + i)
                            // å±€éƒ¨åˆ·æ–°è¡¨æ ¼
                            input.val('')
                        },
                    })
                    return false
                })
            })(i)
        }
    </script>

    <script>
    // æ ‡è®°/å–æ¶ˆæ ‡è®°
        var len = {{ items.count }}
        for(var i=1;i<=len;i++){
            (function (i) {
                $('#demark-' + i).click(function(){
                    if (confirm('æ˜¯å¦å–æ¶ˆæ ‡è®°') == false){
                        return false
                    }
                })
                $('#mark-' + i).click(function(){
                    if (confirm('æ˜¯å¦æ ‡è®°') == false){
                        return false
                    }
                })
            })(i)
        }
    </script>
{% endblock %}